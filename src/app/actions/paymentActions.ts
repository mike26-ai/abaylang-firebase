'use server';

import { Paddle } from '@paddle/paddle-node-sdk';

// NOTE FOR DEVELOPER:
// If you are seeing a "You aren't permitted to perform this request" error,
// it means you are likely using a "Read-Only" API key.
// You MUST generate a key with "Full Access" permissions to create transactions.
// Find this in your Paddle Dashboard under: Developer Tools > Authentication > New API Key
// Ensure "Full Access" is selected when generating the key.

// Initialize Paddle. The SDK will throw an error if the key is missing.
// This check improves error messaging if the environment variable is not set.
if (!process.env.PADDLE_API_KEY || process.env.PADDLE_API_KEY.includes("YOUR_PADDLE_API_KEY")) {
    console.error("CRITICAL: PADDLE_API_KEY is not set in the environment variables. The application cannot process payments.");
    // We throw a generic error to the client for security, but log the specific issue on the server.
}

// Trim whitespace and remove potential quotes from the API key to prevent formatting errors.
const paddleApiKey = (process.env.PADDLE_API_KEY || '').trim().replace(/['"]+/g, '');
const paddle = new Paddle(paddleApiKey);


/**
 * Creates a secure checkout link using the Paddle API.
 *
 * @param lessonType - The type of lesson being booked (e.g., 'quick-practice', 'comprehensive-lesson').
 * @param userEmail - The email of the customer.
 * @param bookingId - The unique ID of the booking document in Firestore.
 * @returns The URL for the Paddle checkout page.
 */
export async function createPaddleCheckout(
  lessonType: string,
  userEmail: string,
  bookingId: string
): Promise<string | undefined> {

  // Step 1: Determine which Paddle Price ID to use based on the lesson type.
  // We fetch these IDs from environment variables for security and flexibility.
  let priceId: string | undefined;

  if (lessonType === 'Quick Practice') {
    priceId = process.env.NEXT_PUBLIC_PADDLE_QUICK_PRACTICE_PRICE_ID;
  } else if (lessonType === 'Comprehensive Lesson') {
    priceId = process.env.NEXT_PUBLIC_PADDLE_COMPREHENSIVE_LESSON_PRICE_ID;
  } else if (lessonType === 'Quick Group Conversation') {
    priceId = process.env.NEXT_PUBLIC_PADDLE_QUICK_GROUP_CONVERSATION_PRICE_ID;
  } else if (lessonType === 'Immersive Conversation Practice') {
    priceId = process.env.NEXT_PUBLIC_PADDLE_IMMERSIVE_CONVERSATION_PRICE_ID;
  } else if (lessonType === 'Quick Practice Bundle') {
    priceId = process.env.NEXT_PUBLIC_PADDLE_QUICK_PRACTICE_BUNDLE_PRICE_ID;
  } else if (lessonType === 'Learning Intensive') {
    priceId = process.env.NEXT_PUBLIC_PADDLE_LEARNING_INTENSIVE_PRICE_ID;
  } else if (lessonType === 'Starter Bundle') {
    priceId = process.env.NEXT_PUBLIC_PADDLE_STARTER_BUNDLE_PRICE_ID;
  } else if (lessonType === 'Foundation Pack') {
    priceId = process.env.NEXT_PUBLIC_PADDLE_FOUNDATION_PACK_PRICE_ID;
  }
  // NOTE: This can be expanded with 'else if' blocks for every other product type.

  // If we couldn't find a matching price ID, we cannot proceed.
  if (!priceId || priceId.includes("YOUR_PADDLE")) {
    console.error(`Error: No valid Paddle Price ID found for lesson type: ${lessonType}. Check your .env.local file.`);
    throw new Error(`The product ID for '${lessonType}' is not configured. Please contact support.`);
  }

  try {
    // Step 2: Call the Paddle API to create a new transaction.
    const transaction = await paddle.transactions.create({
      items: [
        {
          priceId: priceId, // Use the dynamically selected Price ID
          quantity: 1,
        },
      ],
      customer: {
        email: userEmail,
      },
      // We pass our internal bookingId here. This is crucial for the webhook later.
      customData: {
        booking_id: bookingId,
      },
    });

    // Step 3: Return the secure checkout URL generated by Paddle.
    // The optional chaining (?.) is a safe way to access nested properties.
    return transaction.checkout?.url;

  } catch (error: any) {
    // --- IMPROVED ERROR LOGGING ---
    // Log the specific error from the Paddle SDK for better debugging.
    console.error('Paddle SDK Error:', error.message);
    if (error.body) {
      console.error('Paddle Error Details:', JSON.stringify(error.body, null, 2));
    }
    // Throw a more informative error back to the client.
    throw new Error(`Payment provider error: ${error.message}. Please check your Paddle configuration.`);
  }
}
