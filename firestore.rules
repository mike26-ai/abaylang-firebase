/**
 * @file Firestore Security Rules
 * @core_philosophy This ruleset enforces a user-ownership model for user profiles and allows public read access to bookings and time-off blocks.
 *   Administrative actions are not implemented in this prototype.
 * @data_structure
 *   - /users/{userId}: Stores individual user profiles. Access is restricted to the user themselves.
 *   - /bookings/{bookingId}: Stores lesson booking documents. Read access is public.
 *   - /timeOff/{timeOffId}: Stores time-off blocks for tutors. Read access is public.
 * @key_security_decisions
 *   - User listing is explicitly denied for privacy.
 *   - The security posture for ambiguous relationships defaults to strict owner-only access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) A user can create their own profile if the userId matches their auth UID.
     * @allow (get, list, update, delete) A user can only access their own profile.
     * @deny (create) A user cannot create a profile for another user.
     * @deny (get, list, update, delete) A user cannot access another user's profile.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource.data != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if isSignedIn() && isOwner(userId);
    }

    /**
     * @description Controls access to booking documents.
     * @path /bookings/{bookingId}
     * @allow (get, list) Allows public read access to all booking documents.
     * @deny (create, update, delete) Only authenticated users should create bookings with validated data.
     * @principle Allows public read access while restricting write access to authorized users.
     */
    match /bookings/{bookingId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add stricter create rule based on ownership and data validation.
      allow update: if isSignedIn(); // TODO: Implement more restrictive update logic.
      allow delete: if isSignedIn(); // TODO: Implement more restrictive delete logic.
    }

    /**
     * @description Controls access to time-off block documents.
     * @path /timeOff/{timeOffId}
     * @allow (get, list) Allows public read access to all time-off block documents.
     * @deny (create, update, delete) Only authenticated users should create timeOff with validated data.
     * @principle Allows public read access while restricting write access to authorized users.
     */
    match /timeOff/{timeOffId} {
      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add stricter create rule based on ownership and data validation.
      allow update: if isSignedIn(); // TODO: Implement more restrictive update logic.
      allow delete: if isSignedIn(); // TODO: Implement more restrictive delete logic.
    }
  }
}