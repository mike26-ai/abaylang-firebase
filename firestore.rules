
/**
 * @file Overview
 * This ruleset enforces a strict role-based access control model with ownership for user profiles.
 * Admins, identifiable by a "role: admin" field in their user document, have broad access.
 * Users can only create/manage their own profiles and bookings.
 *
 * @keySecurityDecisions
 * - Users can only read and write their own profiles (owner-only).
 * - Admins can override most user-level restrictions.
 * - Write access to availability and timeOff collections is restricted to admins only.
 * - Booking creation/modification is restricted to the owner of the booking.
 * - A user cannot change their own role.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ðŸ”¹ Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    /**
     * @description Manages user profiles. Users can only manage their own profile. Admins have full access.
     * @path /users/{userId}
     * @allow (read, write) if the user is the owner or an admin.
     * @allow (update) only if the user is not trying to change their own role.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin(); // Only admins can list all users.
      allow create: if isOwner(userId); // A user can create their own profile document.
      allow update: if (isOwner(userId) && request.resource.data.role == resource.data.role) || isAdmin(); // Owner can update, but not change their role. Admin can update everything.
      allow delete: if isAdmin(); // Only admins can delete user profiles.
    }

    /**
     * @description Manages lesson bookings. Users can read all, but only write their own.
     * @path /bookings/{bookingId}
     * @allow (read) any user can read any booking.
     * @allow (create) if the user is creating a booking for themselves.
     * @allow (update, delete) if the user is the owner of the booking or an admin.
     */
    match /bookings/{bookingId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if (isSignedIn() && resource.data.userId == request.auth.uid) || isAdmin();
      allow delete: if isAdmin(); // Only admins can delete bookings.
    }
    
    /**
     * @description Manages tutor availability. Publicly readable, admin-only write access.
     * @path /availability/{docId}
     */
    match /availability/{docId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if isAdmin(); // Only admins can manage availability.
    }

    /**
     * @description Manages tutor time off. Publicly readable, admin-only write access.
     * @path /timeOff/{docId}
     */
    match /timeOff/{docId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if isAdmin(); // Only admins can manage time off.
    }

    /**
     * @description Manages testimonials. Publicly readable, creatable by signed-in users, editable by admins.
     * @path /testimonials/{testimonialId}
     */
    match /testimonials/{testimonialId} {
      allow get: if true;
      allow list: if true;
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }
    
    /**
     * @description Manages group sessions. Publicly readable, admin-only write access.
     * @path /groupSessions/{sessionId}
     */
     match /groupSessions/{sessionId} {
        allow get: if true;
        allow list: if true;
        allow create, update, delete: if isAdmin();
     }


    /**
     * @description Fallback rule that denies all other requests.
     * @path /{document=**}
     */
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
