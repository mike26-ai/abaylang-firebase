"use strict";(()=>{var e={};e.id=1777,e.ids=[1777],e.modules={92509:e=>{e.exports=require("firebase-admin")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},51380:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>I,patchFetch:()=>E,requestAsyncStorage:()=>v,routeModule:()=>h,serverHooks:()=>b,staticGenerationAsyncStorage:()=>y});var s={};r.r(s),r.d(s,{POST:()=>f});var i=r(49303),o=r(88716),a=r(60670),n=r(87070),u=r(82421),c=r(21067),l=r(49396),d=r(79109),p=r(44549),m=r(22313);(0,u.xH)();let g=c.Ry({date:c.Z_(),time:c.Z_(),duration:c.Rx().int().positive(),lessonType:c.Z_().min(1),price:c.Rx().min(0),tutorId:c.Z_().min(1),isFreeTrial:c.O7(),userId:c.Z_().min(1),userName:c.Z_().optional(),userEmail:c.Z_().email().optional(),paymentNote:c.Z_().optional()});async function f(e){try{let t=e.headers.get("Authorization")?.split("Bearer ")[1];if(!t)return n.NextResponse.json({success:!1,message:"No authentication token provided."},{status:401});let r=await u.CZ.verifyIdToken(t),s=await e.json(),i=g.safeParse(s);if(!i.success)return n.NextResponse.json({success:!1,message:"Invalid input",details:i.error.flatten()},{status:400});let o=i.data;if(r.uid!==o.userId)return n.NextResponse.json({success:!1,message:"Unauthorized: You can only create bookings for yourself."},{status:403});let a=await u.iW.runTransaction(async e=>{let{tutorId:t,date:r,time:s,duration:i}=o,a=(0,l.Qc)(`${r} ${s}`,"yyyy-MM-dd HH:mm",new Date),n=u.EK.fromDate(a),c=u.EK.fromDate(function(e,t){let r=+(0,d.Q)(e);return(0,p.L)(e,r+t)}(a,i*m.yJ)),g=u.iW.collection("bookings").where("tutorId","==",t).where("status","in",["confirmed","awaiting-payment","payment-pending-confirmation"]).where("startTime","<",c).where("endTime",">",n);if(!(await e.get(g)).empty)throw Error("slot_already_booked");let f=u.iW.collection("timeOff").where("tutorId","==",t).where("startISO","<",c.toDate().toISOString()).where("endISO",">",n.toDate().toISOString());if(!(await e.get(f)).empty)throw Error("tutor_unavailable");let h=u.iW.collection("bookings").doc(),v={...o,startTime:n,endTime:c,createdAt:u.EK.now(),status:o.isFreeTrial?"confirmed":"awaiting-payment"};return e.set(h,v),h.id});return n.NextResponse.json({success:!0,bookingId:a},{status:201})}catch(e){if(console.error("Error in create booking API route:",e),"slot_already_booked"===e.message)return n.NextResponse.json({success:!1,message:"slot_already_booked"},{status:409});if("tutor_unavailable"===e.message)return n.NextResponse.json({success:!1,message:"The tutor is unavailable at this time due to a scheduled break."},{status:409});if("unauthorized"===e.message)return n.NextResponse.json({success:!1,message:"Unauthorized action."},{status:403});return n.NextResponse.json({success:!1,message:"An internal server error occurred."},{status:500})}}let h=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/bookings/create/route",pathname:"/api/bookings/create",filename:"route",bundlePath:"app/api/bookings/create/route"},resolvedPagePath:"/home/user/studio/src/app/api/bookings/create/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:v,staticGenerationAsyncStorage:y,serverHooks:b}=h,I="/api/bookings/create/route";function E(){return(0,a.patchFetch)({serverHooks:b,staticGenerationAsyncStorage:y})}},82421:(e,t,r)=>{r.d(t,{CZ:()=>u,EK:()=>o,iW:()=>n,xH:()=>a});var s=r(92509),i=r.n(s);let o=i().firestore.Timestamp;function a(){if(i().apps.length>0)return i().app();let e={projectId:process.env.FIREBASE_PROJECT_ID,clientEmail:process.env.FIREBASE_CLIENT_EMAIL,privateKey:(process.env.FIREBASE_PRIVATE_KEY||"").replace(/\\n/g,"\n")};if(!e.projectId||!e.clientEmail||!e.privateKey){let e="CRITICAL: Firebase Admin SDK credentials are not set correctly in environment variables. Check your .env file or hosting configuration.";throw console.error(e),Error(e)}try{let t=i().initializeApp({credential:i().credential.cert(e)});return console.log("Firebase Admin SDK initialized successfully."),t}catch(e){if(console.error("CRITICAL: Firebase admin initialization error:",e.message),"app/invalid-credential"===e.code)throw Error("Could not initialize Firebase Admin SDK. The provided credentials are invalid or malformed.");throw Error("Could not initialize Firebase Admin SDK. Please check server logs for details.")}}a();let n=i().firestore(),u=i().auth()}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[8948,5972,1067,9396],()=>r(51380));module.exports=s})();